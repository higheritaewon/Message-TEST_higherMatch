<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>HIGHER MATCH</title>
<link href="https://fonts.googleapis.com/css2?family=Do+Hyeon&display=swap" rel="stylesheet">
<style>
  :root{
    --navy:#0c1a3a;
    --yellow:#ffd94d;
    --bg:#0f1730;
    --card:#131e3f;
    --text:#f4f6ff;
    --muted:#97a2c9;
    --danger:#ff6b6b;
    --success:#2dd4bf;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:linear-gradient(180deg,var(--bg),#0a142e 55%,#08102a);
    color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,Helvetica,Arial,sans-serif;
    font-size:18px;
    line-height:1.45;
  }
  .container{max-width:480px;margin:0 auto;padding:16px 14px 28px}
  .card{
    background:rgba(19,30,63,.7);
    backdrop-filter: blur(6px);
    border:1px solid rgba(255,255,255,.06);
    border-radius:16px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.35);
  }
  h1,h2,h3{margin:0 0 14px}
  h1.title{
    font-size:30px;
    letter-spacing:.8px; text-align:center; margin-top:8px;
    background:linear-gradient(90deg,#fff,var(--yellow)); -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    font-family: 'Do Hyeon', sans-serif;
  }
  .page-title{
    text-align:center; font-size:28px;
    margin-bottom:8px;
    font-family: 'Do Hyeon', sans-serif;
  }
  .subtitle{color:var(--muted); font-size:18px; text-align:center; margin-top:-6px; margin-bottom:14px}

  .logo-wrap{display:flex;flex-direction:column;align-items:center;gap:10px;margin:8px 0 16px}
  .logo{
    width:240px;height:auto;object-fit:contain;display:block;border-radius:12px;border:1px dashed rgba(255,255,255,.15);background:#0b1532;
  }
  .logo-mini{
    width:200px;height:auto;object-fit:contain;display:block;border-radius:12px;border:1px dashed rgba(255,255,255,.15);background:#0b1532;margin:0 auto 6px;
  }

  .row{display:flex;gap:10px}
  input,button,textarea,select{
    width:100%; padding:14px 13px; border-radius:12px;
    border:1px solid rgba(255,255,255,.08); background:#0b1532; color:#f4f6ff; font-size:16px;
  }
  input::placeholder,textarea::placeholder{color:#7e8bb8}
  textarea{resize:none; min-height:90px}
  button{cursor:pointer; font-weight:700; letter-spacing:.2px}
  .btn{background:#13265a}
  .btn:hover{filter:brightness(1.06)}
  .btn-primary{background:var(--yellow); color:#1a1a1a; border-color:#0000}
  .btn-accent{background:#1a2b63; border:1px solid #2a3b7a}
  .btn-like{background:#1c2f6e; border:1px solid #2e4aa7}
  .btn-focus{outline:2px solid var(--yellow)}
  .btn-danger{background:var(--danger)}
  .btn-success{background:var(--success); color:#0e2824}
  .badge{
    display:inline-block; padding:2px 8px; border:1px solid rgba(255,255,255,.15);
    border-radius:999px; font-size:18px;
    background:#0e1f4a;
  }
  /* âœ… ëŒ€í™”ëª©ë¡ìš© ë¹¨ê°„ ë±ƒì§€ */
  .badge-red{
    background:#ff6b6b;          
    border-color:rgba(255,255,255,.15);
    color:#fff;
  }
  .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  .tile{
    display:flex;flex-direction:column;gap:8px;align-items:center;justify-content:center;
    padding:18px 12px; border-radius:14px; text-align:center;
    min-height:200px;
    background:#0f1f4b; border:1px solid rgba(255,255,255,.06)
  }
  .tile strong{font-size:30px; font-family:'Do Hyeon', sans-serif;}
  .tile.like{background:#14265a; border:1px solid #29418d; box-shadow:0 0 0 2px rgba(41,65,141,.25) inset}
  .tile.like strong{ color: var(--yellow); }

  .muted{color:var(--muted); font-size:16px}
  .small{font-size:14px}
  .center{text-align:center}
  .spacer{height:8px}
  .footerbar{
    margin-top:16px; display:flex; align-items:center; justify-content:space-between; gap:10px; color:var(--muted); font-size:14px
  }
  .list{display:flex;flex-direction:column; gap:10px}
  .list-item{
    display:flex; align-items:center; gap:10px;
    padding:12px; border-radius:12px; background:#0d1a3e; border:1px solid rgba(255,255,255,.06)
  }

  /* ê²€ìƒ‰ í–‰ */
  .search-row{ display:flex; align-items:center; gap:8px; margin:6px 0 10px; }
  #browse-search-input{ flex:1 1 auto; min-width:0; padding:12px 12px; font-size:16px; border-radius:10px; }
  #browse-search-btn,#browse-search-clear{ flex:0 0 88px; padding:10px 0; text-align:center; font-size:15px; border-radius:10px; }

  .hidden{display:none !important}
  .li-content{ flex: 2; min-width:0; }
  .li-actions{ flex: 1; display:flex; justify-content:flex-end; align-items:stretch; }
  .li-actions .btn-like{ width:100%; }

  /* ===== MODAL ===== */
  .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:50 }
  .modal{
    width:90%; max-width:480px;
    background:#0d1534; border:1px solid rgba(255,255,255,.1); border-radius:16px; padding:18px;
    font-size:1.5em; line-height:1.4;
  }
  .modal h3{margin:0 0 10px; font-size:1.2em;}
  .modal .actions{display:flex; gap:12px; margin-top:14px}
  #modal-title, #modal-message { text-align: center; }
  #modal-message { font-size: 18px; line-height: 1.5;}

  /* ===== ë¡œë”© ì˜¤ë²„ë ˆì´ ===== */
  .loading-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:60; }
  .loading-box{ background:#0d1534; border:1px solid rgba(255,255,255,.12); padding:14px 16px; border-radius:12px; font-size:16px; display:flex; align-items:center; gap:10px; }
  .spinner{ width:16px; height:16px; border:3px solid rgba(255,255,255,.2); border-top-color:#fff; border-radius:50%; animation:spin 1s linear infinite; }
  @keyframes spin{to{transform:rotate(360deg)}}

  /* ===== BIG LIKE COUNTER ===== */
  .counter-banner{ margin:6px 0 12px; padding:14px 16px; border-radius:14px; background:#09163a; border:1px solid rgba(255,255,255,.08); text-align:center; }
  .counter-banner .num{ font-size:28px; font-weight:800; letter-spacing:.5px; font-family:'Do Hyeon', sans-serif; }
  .counter-banner .cap{display:block; margin-top:6px; font-size:16px; color:var(--muted)}
  .counter-banner.exhausted{background:#2a0e12; border-color:#3b1318}

/* ===== ì±„íŒ… UI (ì•ˆì • ë ˆì´ì•„ì›ƒ) ===== */
.chat-box{
  max-height:420px;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  gap:8px;
  padding:8px;
  border-radius:12px;
  background:#0c1433;
  border:1px solid rgba(255,255,255,.08);
}

/* ë©”ì‹œì§€ í•œ ì¤„(ë§í’ì„ +ë©”íƒ€) */
.msg-row{
  display:flex;
  flex-direction:row;      /* â† ì ˆëŒ€ column ë°©ì§€ */
  align-items:flex-end;    /* ì‹œê°„í‘œì‹œë¥¼ ë§í’ì„  í•˜ë‹¨ ê¸°ì¤€ìœ¼ë¡œ ë§ì¶¤ */
  gap:6px;
}
.msg-row.me{ justify-content:flex-end; }
.msg-row.other{ justify-content:flex-start; }

/* ë§í’ì„ ë§Œ ë‹´ëŠ” ë˜í¼ (í­ ì œí•œì€ ì—¬ê¸°ì„œ) */
.msg-wrap{
  max-width:76%;           /* í™”ë©´í­ì˜ 3/4 ì •ë„ë§Œ ì°¨ì§€ */
  display:block;           /* inline ìš”ì†Œ í­ ê¹¨ì§ ë°©ì§€ */
}

/* ë§í’ì„  ë³¸ì²´ */
.bubble{
  display:inline-block;    /* í…ìŠ¤íŠ¸ ì˜†ìœ¼ë¡œ ì„¸ë¡œ ìŒ“ì„ ë°©ì§€ */
  max-width:100%;          /* ë˜í¼ í­ ì•ˆì—ì„œë§Œ ì¤„ë°”ê¿ˆ */
  padding:8px 10px;
  border-radius:12px;
  word-break:break-word;
  overflow-wrap:break-word;
  white-space:pre-wrap;    /* ê°œí–‰/ì´ëª¨ì§€ ì•ˆì „ */
}
.me{ background:#1a2b63; }
.other{ background:#26336d; }

/* ì‹œê°„/ì½ìŒ ë©”íƒ€ (í•­ìƒ ì˜†, ì¤„ë°”ê¿ˆ ì—†ìŒ) */
.msg-meta{
  flex:0 0 auto;           /* í­ ê³ ì •, ì¤„ë°”ê¿ˆ ê¸ˆì§€ */
  white-space:nowrap;
  font-size:.75em;
  color:var(--muted);
  margin:0 2px 2px 2px;
  line-height:1.1;
}

/* ì‘ì€ í™”ë©´ì—ì„œ ë§í’ì„  ì¡°ê¸ˆ ë” ë„“ê²Œ */
@media (max-width:420px){
  .msg-wrap{ max-width:80%; }
}
  
  .msg-toolbar{ display:flex; gap:10px; margin-top:10px; }
  .menu-msg-button{
    display:flex; align-items:center; justify-content:center; gap:8px;
    padding:12px; border-radius:12px; background:#1a2b63; border:1px solid #2a3b7a; width:100%;
  }
  .menu-msg-button .badge{ background:#0b225d; }
</style>
</head>
<body>
<div class="container">

  <!-- ===== [PAGE] ì²«í˜ì´ì§€ ===== -->
  <section id="page-welcome" class="card">
    <div class="logo-wrap">
      <img id="logo-main" class="logo" src="https://lh3.googleusercontent.com/d/143lu87wt27PIerpMbBNSViSsHabI0dZd" alt="HIGHER MATCH ë¡œê³ " />
    </div>
    <h1 class="title">HIGHERì—ì„œ ì¸ì—° ì°¾ê¸°</h1>
    <div class="spacer"></div>
    <div class="row">
      <input id="login-uid" inputmode="numeric" pattern="[0-9]*" placeholder="ë‚˜ì˜ ê³ ìœ ë²ˆí˜¸" />
      <input id="login-pin" inputmode="numeric" pattern="[0-9]*" placeholder="ë¹„ë°€ë²ˆí˜¸(4ìë¦¬)" maxlength="4" />
    </div>
    <div class="spacer"></div>
    <div class="row">
      <button class="btn" id="signup-btn">ë“±ë¡í•˜ê¸°</button>
      <button class="btn-primary" id="login-btn">ë¡œê·¸ì¸</button>
    </div>
    <div class="spacer"></div>
    <div class="center">
      <button id="admin-entry-btn" class="btn-accent small">ê´€ë¦¬ì</button>
    </div>
    <div class="spacer"></div>
    <p class="subtitle small">
      <br>ì´ë²¤íŠ¸ìš© ìµëª… ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.<br>BETA SERVICE @higher_itaewon<br>
    </p>
  </section>

  <div id="topbar-common" class="hidden"></div>

  <!-- ===== [PAGE] ë©”ë‰´ ===== -->
  <section id="page-menu" class="card hidden">
    <div class="grid">
      <button class="tile" id="btn-profile">
        <strong>ğŸ‘¤<br>í”„ë¡œí•„<br>ì„¤ì •í•˜ê¸°</strong>
        <span class="muted small">ìê¸°ì†Œê°œÂ·ì´ìƒí˜•</span>
      </button>
      <button class="tile" id="btn-browse">
        <strong>ğŸ‘€<br>ë‹¤ë¥¸ì‚¬ëŒ<br>êµ¬ê²½í•˜ê¸°</strong>
        <span class="muted small">ë²ˆí˜¸ìˆœ í”„ë¡œí•„</span>
      </button>
      <button class="tile like" id="btn-like">
        <strong>ğŸ‘<br>LIKE<br>ë³´ë‚´ê¸°</strong>
        <span class="muted small">ë²ˆí˜¸ ì…ë ¥í•˜ì—¬ ì „ì†¡</span>
      </button>
      <button class="tile" id="btn-matches">
        <strong>ë‚˜ì˜<br>MATCH<br>ğŸ’›</strong>
        <span class="muted small">ë§Œë‚¨ ìš”ì²­/ìˆ˜ë½</span>
      </button>
    </div>

    <!-- âœ… ë©”ë‰´íŒ ì•„ë˜, ë¡œê·¸ì•„ì›ƒ ì‚¬ì´: ë©”ì„¸ì§€í•¨ ë²„íŠ¼ (ë±ƒì§€ í¬í•¨) -->
    <div class="spacer"></div>
    <button class="menu-msg-button" id="btn-messages">
      <span style="font-family:'Do Hyeon',sans-serif;font-size:22px;">âœ‰ï¸ ë©”ì„¸ì§€í•¨</span>
      <span id="msg-badge" class="badge hidden">0</span>
    </button>

    <p id="login-status-menu" class="center muted small" style="margin-top:12px;"></p>

    <div class="footerbar">
      <span></span>
      <button id="logout-btn" class="btn small">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </section>

  <!-- ===== [PAGE] í”„ë¡œí•„ ì„¤ì •í•˜ê¸° ===== -->
  <section id="page-profile" class="card hidden">
    <img class="logo-mini" id="logo-mini-profile" alt="ë¡œê³ " />
    <h2 class="page-title">ğŸ‘¤í”„ë¡œí•„ ì„¤ì •í•˜ê¸°</h2>

    <p class="muted">ë‚´ ê³ ìœ ë²ˆí˜¸: <span class="badge" id="me-uid-profile"></span><br>*ë¯¼ê°í•˜ê±°ë‚˜ ë¶ˆì¾Œê°ì„ ì¤„ ìˆ˜ ìˆëŠ” ë‚´ìš© ì‘ì„±ì€ ìì œë°”ëë‹ˆë‹¤.</p>
    <textarea id="intro" maxlength="50" placeholder="ìê¸°ì†Œê°œ (ìµœëŒ€ 50ì)  ex. ì˜¤ëŠ˜ ë²ˆê°œ êµ¬í•´ìš”."></textarea>
    <div class="spacer"></div>
    <textarea id="ideal" maxlength="50" placeholder="ì´ìƒí˜• (ìµœëŒ€ 50ì)  ex. ì§§ì€ ë¨¸ë¦¬ ê°ììƒ"></textarea>

    <p id="login-status-profile-top" class="center muted small" style="margin-top:12px;"></p>

    <div class="spacer"></div>
    <div class="row">
      <button class="btn" id="profile-cancel">ì·¨ì†Œ</button>
      <button class="btn-primary" id="profile-save">ì €ì¥</button>
    </div>
    <div class="footerbar">
      <button id="to-menu1" class="btn small">ë’¤ë¡œê°€ê¸° â†©ï¸</button>
      <button id="logout-btn1" class="btn small">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </section>

  <!-- ===== [PAGE] ë‹¤ë¥¸ì‚¬ëŒ êµ¬ê²½í•˜ê¸° ===== -->
  <section id="page-browse" class="card hidden">
    <img class="logo-mini" id="logo-mini-browse" alt="ë¡œê³ " />
    <h2 class="page-title">ë‹¤ë¥¸ì‚¬ëŒ êµ¬ê²½í•˜ê¸°ğŸ‘€</h2>

    <div id="like-counter-browse" class="counter-banner">
      <span class="num" id="like-remaining-browse-num">ë‚¨ì€ LIKE: 0 / 0</span>
      <span class="cap">ë‚¨ì€ íšŸìˆ˜ê°€ 0ì´ë©´ LIKEë¥¼ ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</span>
    </div>

    <div class="search-row">
      <input id="browse-search-input" inputmode="numeric" pattern="[0-9]*" placeholder="ë²ˆí˜¸ë¡œ ê²€ìƒ‰" />
      <button id="browse-search-btn" class="btn small">ê²€ìƒ‰</button>
      <button id="browse-search-clear" class="btn small">ì „ì²´</button>
    </div>

    <div id="browse-list" class="list"></div>

    <p id="login-status-browse-top" class="center muted small" style="margin-top:12px;"></p>

    <div class="footerbar">
      <button id="to-menu2" class="btn small">ë’¤ë¡œê°€ê¸° â†©ï¸</button>
      <button id="logout-btn2" class="btn small">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </section>

  <!-- ===== [PAGE] LIKE ë³´ë‚´ê¸° ===== -->
  <section id="page-like" class="card hidden">
    <img class="logo-mini" id="logo-mini-like" alt="ë¡œê³ " />
    <h2 class="page-title">ğŸ‘LIKE ë³´ë‚´ê¸°</h2>

    <div id="like-counter-like" class="counter-banner">
      <span class="num" id="like-remaining-like-num">ë‚¨ì€ LIKE: 0 / 0</span>
      <span class="cap">ë‚¨ì€ íšŸìˆ˜ê°€ 0ì´ë©´ LIKEë¥¼ ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</span>
    </div>

    <div class="row">
      <input id="from-like" disabled />
      <input id="to-like" inputmode="numeric" pattern="[0-9]*" placeholder="ìƒëŒ€ë°© ë²ˆí˜¸ ì…ë ¥" />
    </div>
    <div class="spacer"></div>
    <button id="send-like-btn" class="btn-like btn-focus">LIKE ë³´ë‚´ê¸°</button>
    <p class="muted small" style="margin-top:10px;">â€» ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë²ˆí˜¸ë¡œëŠ” ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>

    <p id="login-status-like-top" class="center muted small" style="margin-top:12px;"></p>

    <div class="footerbar">
      <button id="to-menu3" class="btn small">ë’¤ë¡œê°€ê¸° â†©ï¸</button>
      <button id="logout-btn3" class="btn small">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </section>

  <!-- ===== [PAGE] ë‚˜ì˜ MATCH í˜„í™©ë³´ê¸° ===== -->
  <section id="page-matches" class="card hidden">
    <img class="logo-mini" id="logo-mini-matches" alt="ë¡œê³ " />
    <h2 class="page-title">ë‚˜ì˜ MATCH ğŸ’›</h2>

    <div id="matches-list" class="list"></div>

    <p id="login-status-matches-top" class="center muted small" style="margin-top:12px;"></p>

    <div class="footerbar">
      <button id="to-menu4" class="btn small">ë’¤ë¡œê°€ê¸° â†©ï¸</button>
      <button id="logout-btn4" class="btn small">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </section>

  <!-- ===== [PAGE] ë©”ì„¸ì§€í•¨ ===== -->
  <section id="page-messages" class="card hidden">
    <img class="logo-mini" id="logo-mini-messages" alt="ë¡œê³ " />
    <h2 class="page-title">âœ‰ï¸ ë©”ì„¸ì§€í•¨</h2>

    <div id="message-list" class="list"></div>
    <p id="no-messages" class="muted small center hidden">ì•„ì§ ë§¤ì¹˜ëœ ì‚¬ëŒì´ ì—†ìŠµë‹ˆë‹¤.</p>

    <div class="footerbar">
      <button id="to-menu-msg" class="btn small">ë’¤ë¡œê°€ê¸° â†©ï¸</button>
      <button id="logout-btn-msg" class="btn small">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </section>

  <!-- ===== [PAGE] ê°œë³„ ì±„íŒ…ì°½ ===== -->
  <section id="page-chat" class="card hidden">
    <h2 class="page-title"><span id="chat-with"></span>ë²ˆê³¼ ëŒ€í™”</h2>

    <div id="chat-box" class="chat-box"></div>

    <div class="msg-toolbar">
      <input id="chat-input" maxlength="20" placeholder="20ì ì´ë‚´ë¡œ ì…ë ¥" />
      <button id="chat-send" class="btn-primary small">ë³´ë‚´ê¸°</button>
    </div>

    <p class="small muted center" id="chat-info"></p>

    <div class="footerbar">
      <button id="back-to-messages" class="btn small">ë’¤ë¡œê°€ê¸° â†©ï¸</button>
      <button id="logout-btn-chat" class="btn small">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </section>

  <!-- ===== [PAGE] ê´€ë¦¬ì ê²Œì´íŠ¸ ===== -->
  <section id="page-admin-gate" class="card hidden">
    <h2>ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
    <p class="muted small">ê´€ë¦¬ì ìê²©ì€ ì½”ë“œ ë‚´ë¶€ì— ê³ ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p>
    <div class="row">
      <input id="admin-id" placeholder="ê´€ë¦¬ì ì•„ì´ë””" />
      <input id="admin-pw" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸" type="password" />
    </div>
    <div class="spacer"></div>
    <div class="row">
      <button id="admin-cancel" class="btn">ì·¨ì†Œ</button>
      <button id="admin-login" class="btn-primary">ê´€ë¦¬ì ì ‘ì†</button>
    </div>
  </section>

  <!-- ===== [PAGE] ê´€ë¦¬ì ===== -->
  <section id="page-admin" class="card hidden">
    <h2>ê´€ë¦¬ì í˜ì´ì§€</h2>
    <div class="spacer"></div>

    <div class="row">
      <input id="event-id-input" placeholder="ì´ë²¤íŠ¸ ID" />
      <button id="apply-event-id" class="btn">ì´ë²¤íŠ¸ID ì ìš©</button>
    </div>
    <p class="small muted">í˜„ì¬ ì´ë²¤íŠ¸: <span class="badge" id="current-event"></span></p>

    <div class="row" style="margin-top:10px;">
      <button id="admin-tab-search" class="btn">ì‚¬ìš©ì<br>ê²€ìƒ‰/ê´€ë¦¬</button>
      <button id="admin-tab-matches" class="btn">ë§¤ì¹˜/ë§Œë‚¨ ëª©ë¡</button>
      <button id="admin-tab-draw" class="btn">ëœë¤<br>ë²ˆí˜¸ë½‘ê¸°</button>
    </div>

    <!-- ì‚¬ìš©ì ê²€ìƒ‰/ê´€ë¦¬ -->
    <div id="admin-panel-search" style="margin-top:12px;">
      <h3>ì‚¬ìš©ì ê²€ìƒ‰/ê´€ë¦¬</h3>
      <div class="row">
        <input id="admin-search-uid" inputmode="numeric" pattern="[0-9]*" placeholder="ê³ ìœ ë²ˆí˜¸ ì…ë ¥" />
        <button id="admin-search-btn" class="btn">ì¡°íšŒ</button>
      </div>
      <div id="admin-user-summary" class="small muted" style="margin:8px 0;"></div>

      <div class="row">
        <input id="admin-like-limit" inputmode="numeric" pattern="[0-9]*" placeholder="ì œí•œ" />
        <button id="admin-like-limit-dec" class="btn">-</button>
        <button id="admin-like-limit-inc" class="btn">+</button>
        <button id="admin-like-limit-save" class="btn-primary">ì €ì¥</button>
      </div>

      <h4 style="margin-top:12px">ë³´ë‚¸ LIKE ëª©ë¡</h4>
      <div id="admin-sent-list" class="list"></div>
      <h4 style="margin-top:12px">ë°›ì€ LIKE ëª©ë¡</h4>
      <div id="admin-recv-list" class="list"></div>

      <h4 style="margin-top:12px">íŠ¹ì • ì‚¬ìš©ì ë°ì´í„° ì‚­ì œ</h4>
      <div class="row">
        <button id="admin-wipe-user" class="btn-danger">ì´ ì‚¬ìš©ì ë°ì´í„° ì „ë¶€ ì‚­ì œ</button>
      </div>
    </div>

    <!-- ë§¤ì¹˜/ë§Œë‚¨ ëª©ë¡ -->
    <div id="admin-panel-matches" class="hidden" style="margin-top:12px;">
      <h3>ë§¤ì¹˜/ë§Œë‚¨ ëª©ë¡</h3>
      <h4 style="margin-top:8px">MATCH ëª©ë¡</h4>
      <div id="admin-matches" class="list"></div>
      <p class="small">ì „ì²´ ë§¤ì¹˜ ìˆ˜: <span class="count" id="admin-match-count">0</span></p>

      <h4 style="margin-top:8px">ë§Œë‚¨ ì„±ì‚¬ ëª©ë¡</h4>
      <div id="admin-meetings" class="list"></div>
      <p class="small">ì „ì²´ ì„±ì‚¬ ìˆ˜: <span class="count" id="admin-meet-count">0</span></p>

      <h4 style="margin-top:14px">ê°œë³„ ì‚¬ìš©ì ì‚­ì œ</h4>
      <div class="row">
        <input id="admin-del-uid" placeholder="ì‚­ì œí•  ë²ˆí˜¸" inputmode="numeric" pattern="[0-9]*" />
        <button id="admin-del-user" class="btn-danger">í•´ë‹¹ ì‚¬ìš©ì<br>ë°ì´í„° ì‚­ì œ</button>
      </div>

      <h4 style="margin-top:14px">ì´ë²¤íŠ¸ ì „ì²´ ì´ˆê¸°í™”</h4>
      <button id="admin-reset" class="btn-danger">ëª¨ë“  ê³„ì •/ë°ì´í„° ì™„ì „ ì‚­ì œ</button>
    </div>

        <!-- ëœë¤ ë²ˆí˜¸ ë½‘ê¸° (âœ… ë³µêµ¬) -->
    <div id="admin-panel-draw" class="hidden" style="margin-top:12px;">
      <h3>ëœë¤ ë²ˆí˜¸ ë½‘ê¸°</h3>
      <p class="small muted">í˜„ì¬ ë“±ë¡ëœ ë²ˆí˜¸ë“¤ ì¤‘ì—ì„œ ì¤‘ë³µ ì—†ì´ ê°ê°ì˜ í’€ì—ì„œ ì¶”ì²¨ë©ë‹ˆë‹¤.</p>
      <div class="row" style="margin-top:8px;">
        <button id="draw-host" class="btn-primary">ğŸ¤ ì§„í–‰ììš©<br>ëœë¤ë²ˆí˜¸ ë½‘ê¸°</button>
        <button id="draw-guest" class="btn-primary">ğŸ‰ ì°¸ê°€ììš©<br>ëœë¤ë²ˆí˜¸ ë½‘ê¸°</button>
      </div>
      <div class="row" style="margin-top:8px;">
        <button id="draw-reset" class="btn">ì¶”ì²¨ ì´ˆê¸°í™”</button>
      </div>
      <div style="margin-top:10px;">
        <div><strong>ì§„í–‰ììš© ì´ë¯¸ ë½‘íŒ ë²ˆí˜¸:</strong> <span id="draw-host-drawn" class="badge"></span></div>
        <div style="margin-top:6px;"><strong>ì°¸ê°€ììš© ì´ë¯¸ ë½‘íŒ ë²ˆí˜¸:</strong> <span id="draw-guest-drawn" class="badge"></span></div>
      </div>
    </div>
    
    <div class="spacer"></div>
    <button id="admin-logout" class="btn small">ê´€ë¦¬ì ë¡œê·¸ì•„ì›ƒ</button>
  </section>

</div>

<!-- ===== ê¸°ë³¸ ëª¨ë‹¬ ===== -->
<div id="modal" class="modal-backdrop">
  <div class="modal">
    <h3 id="modal-title">ì•Œë¦¼</h3>
    <div id="modal-message" class="muted" style="white-space:pre-line"></div>
    <div class="actions" id="modal-actions">
      <button id="modal-ok" class="btn-primary">í™•ì¸</button>
    </div>
  </div>
</div>

<!-- ===== ë¡œë”©(ëŒ€ê¸° ì•ˆë‚´) ì˜¤ë²„ë ˆì´ ===== -->
<div id="loading" class="loading-backdrop">
  <div class="loading-box">
    <div class="spinner"></div>
    <div>ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...</div>
  </div>
</div>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getDatabase, ref, get, set, update, onValue, remove, runTransaction } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
  import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, inMemoryPersistence } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

  // ===================== í™˜ê²½ ì„¤ì • =====================
  const firebaseConfig = {
  apiKey: "AIzaSyAXvxr9ob7XOd2X3cKFqIMQGuyXjrXmJ2k",
  authDomain: "message-test-highermatch.firebaseapp.com",
  databaseURL: "https://message-test-highermatch-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "message-test-highermatch",
  storageBucket: "message-test-highermatch.firebasestorage.app",
  messagingSenderId: "1089942564607",
  appId: "1:1089942564607:web:1fc999e50f0614253326ca",
  measurementId: "G-PZGV0QX193"
  };

  let EVENT_ID = localStorage.getItem("hm_event_id") || "defaultEvent";
  const ADMIN_ID = "admin";
  const ADMIN_PASSWORD = "higher1011!";

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  // ===================== ìƒíƒœ =====================
  let currentUid = null;
  let currentPin = null;
  let adminLoggedIn = false;
  let isConnected = null;
  let likeRemain = 0;
  let likeLimit = 0;

  // ë©”ì„¸ì§€ ê´€ë ¨ ìƒíƒœ
  let messagePairListeners = []; // ë±ƒì§€ìš© ë¦¬ìŠ¤ë„ˆ í•´ì œ ëª©ë¡
  let chatListener = null;       // ê°œë³„ ì±„íŒ… ë¦¬ìŠ¤ë„ˆ

  // ===================== DOM í—¬í¼ =====================
  const $ = s => document.querySelector(s);
  function show(el){
    el.classList.remove("hidden");
    if (el.classList.contains("modal-backdrop") || el.classList.contains("loading-backdrop")) {
      el.style.display = "flex";
    }
  }
  function hide(el){
    el.classList.add("hidden");
    if (el.classList.contains("modal-backdrop") || el.classList.contains("loading-backdrop")) {
      el.style.display = "none";
    }
  }

  const loadingEl = $("#loading");
  const withLoading = async (fn) => { try{ show(loadingEl); await fn(); } finally{ hide(loadingEl); } };

  const pages = {
    welcome: $("#page-welcome"),
    menu: $("#page-menu"),
    profile: $("#page-profile"),
    browse: $("#page-browse"),
    like: $("#page-like"),
    matches: $("#page-matches"),
    messages: $("#page-messages"),   // âœ… ë©”ì„¸ì§€í•¨
    chat: $("#page-chat"),           // âœ… ì±„íŒ…
    adminGate: $("#page-admin-gate"),
    admin: $("#page-admin")
  };

  const logoMain = $("#logo-main");
  function setAllMiniLogos(){
    document.querySelectorAll(".logo-mini").forEach(img=>{ img.src = logoMain.src; });
  }
  setAllMiniLogos();

  // ===================== ëª¨ë‹¬ =====================
  const modal = $("#modal");
  const modalTitle = $("#modal-title");
  const modalMsg = $("#modal-message");
  const modalActions = $("#modal-actions");

  function alertModal(message, title="ì•Œë¦¼"){
    if (loadingEl) hide(loadingEl);
    return new Promise(res=>{
      modalTitle.textContent = title;
      modalMsg.textContent = String(message).replace(/\n{3,}/g, "\n\n");
      modalActions.innerHTML = `<button id="modal-ok" class="btn-primary">í™•ì¸</button>`;
      $("#modal-ok").onclick = ()=>{ hide(modal); res(true); };
      show(modal);
    });
  }
   function confirmModal(message, {
  okText="í™•ì¸",
  cancelText="ì·¨ì†Œ",
  title="í™•ì¸",
  okClass="btn-primary"         // âœ… ì¶”ê°€: OK ë²„íŠ¼ í´ë˜ìŠ¤ ì§€ì •
} = {}){
  if (loadingEl) hide(loadingEl);
  return new Promise(res=>{
    modalTitle.textContent = title;
    modalMsg.textContent = String(message).replace(/\n{3,}/g, "\n\n");
    modalActions.innerHTML = `
      <button id="modal-cancel" class="btn">${cancelText}</button>
      <button id="modal-ok" class="${okClass}">${okText}</button>`;  // âœ… okClass ë°˜ì˜
    $("#modal-cancel").onclick = ()=>{ hide(modal); res(false); };
    $("#modal-ok").onclick = ()=>{ hide(modal); res(true); };
    show(modal);
  });
}
  function choiceModal(message){
    if (loadingEl) hide(loadingEl);
    return new Promise(res=>{
      modalTitle.textContent = "ë§Œë‚¨ ìš”ì²­";
      modalMsg.textContent = String(message).replace(/\n{3,}/g, "\n\n");
      modalActions.innerHTML = `
        <button id="modal-decline" class="btn-danger">ê±°ì ˆ</button>
        <button id="modal-hold" class="btn">ë³´ë¥˜</button>
        <button id="modal-accept" class="btn-primary">ìˆ˜ë½</button>
      `;
      $("#modal-decline").onclick = ()=>{ hide(modal); res(false); };
      $("#modal-hold").onclick = ()=>{ hide(modal); res(null); };
      $("#modal-accept").onclick = ()=>{ hide(modal); res(true); };
      show(modal);
    });
  }

  // ===================== ì—°ê²° ìƒíƒœ ë¼ë²¨ ì²˜ë¦¬ =====================
  function updateConnectionLabels(){
    const suffix = (isConnected===null) ? "" : (isConnected ? " Â· ì‹¤ì‹œê°„: ì—°ê²°ë¨" : " Â· ì‹¤ì‹œê°„: ì˜¤í”„ë¼ì¸");
    const base = currentUid ? `${currentUid}ë²ˆ ë‹˜ì´ ë¡œê·¸ì¸ ì¤‘ì…ë‹ˆë‹¤` : "";
    const textTop = base + suffix;

    ["#login-status-menu","#login-status-profile-top","#login-status-browse-top","#login-status-like-top","#login-status-matches-top"]
      .forEach(sel=>{ const el=$(sel); if(el) el.textContent=textTop; });

    const fromLike = $("#from-like");
    if(fromLike){ fromLike.value = currentUid ? `ë‚´ ë²ˆí˜¸: ${currentUid}` : ""; }
  }

  // ===================== DB ìœ í‹¸ =====================
  const r = (p)=> ref(db, `events/${EVENT_ID}/${p}`);
  async function getUser(uid){ const snap = await get(r(`users/${uid}`)); return snap.exists()? snap.val(): null; }
  async function userExists(uid){ return !!(await getUser(uid)); }
  async function countLikesSent(uid){
    const snap = await get(r(`likes/${uid}`));
    if(!snap.exists()) return 0;
    return Object.keys(snap.val()).length;
  }
  const makeChatKey = (a,b)=> [Math.min(+a,+b), Math.max(+a,+b)].join("-");

  // ===== LIKE ì¹´ìš´í„°/ë°°ë„ˆ/UI =====
  function setLikeUI(remain, limit){
    likeRemain = remain; likeLimit = limit;
    const n1 = $("#like-remaining-like-num");
    const n2 = $("#like-remaining-browse-num");
    if(n1) n1.textContent = `ë‚¨ì€ LIKE: ${remain} / ${limit}`;
    if(n2) n2.textContent = `ë‚¨ì€ LIKE: ${remain} / ${limit}`;

    const b1 = $("#like-counter-like");
    const b2 = $("#like-counter-browse");
    const exhausted = (remain<=0);
    [b1,b2].forEach(b=>{ if(!b) return; b.classList.toggle("exhausted", exhausted); });

    const sendBtn = $("#send-like-btn");
    if(sendBtn){ sendBtn.title = exhausted ? "LIKEë¥¼ ëª¨ë‘ ì‚¬ìš©í•˜ì˜€ìŠµë‹ˆë‹¤." : ""; }

    document.querySelectorAll("[data-like]").forEach(btn=>{
      btn.title = exhausted ? "LIKEë¥¼ ëª¨ë‘ ì‚¬ìš©í•˜ì˜€ìŠµë‹ˆë‹¤." : "";
    });
  }
  async function refreshLikeCounters(){
    if(!currentUid) return;
    const u = await getUser(currentUid);
    const limit = (u && typeof u.likeLimit==="number") ? u.likeLimit : 7;
    const sentCount = (u && typeof u.likeSentCount==="number") ? u.likeSentCount : await countLikesSent(currentUid);
    const remain = Math.max(0, limit - sentCount);
    setLikeUI(remain, limit);
  }

  // ===================== Auth ì´ˆê¸°í™” =====================
  async function initAuth(){
    try{
      await setPersistence(auth, inMemoryPersistence);
      await signInAnonymously(auth);
    }catch(e){ console.error("Auth init error:", e); }
    return new Promise((resolve)=>{
      if(auth.currentUser) return resolve(auth.currentUser);
      const unsub = onAuthStateChanged(auth, (u)=>{unsub(); resolve(u);});
    });
  }
  await initAuth();

  // ===================== .info/connected =====================
  onValue(ref(db, ".info/connected"), (snap)=>{
    isConnected = (snap.val() === true);
    updateConnectionLabels();
  });

  // ===================== íšŒì›ê°€ì…/ë¡œê·¸ì¸ =====================
  $("#signup-btn").onclick = async ()=>{
    await withLoading(async ()=>{
      try{
        const uid = $("#login-uid").value.trim();
        const pin = $("#login-pin").value.trim();
        if(!uid || !/^\d+$/.test(uid)) return alertModal("ê³ ìœ ë²ˆí˜¸ëŠ” ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.");
        if(!/^\d{4}$/.test(pin)) return alertModal("ë¹„ë°€ë²ˆí˜¸ëŠ” ìˆ«ì 4ìë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤.");
        if(await userExists(uid)) return alertModal("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë²ˆí˜¸ì…ë‹ˆë‹¤.\n\në¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.");
        await set(r(`users/${uid}`), { pin, intro:"", ideal:"", createdAt: Date.now(), likeLimit:7, likeSentCount:0 });
        await alertModal("ê³„ì •ì´ ìƒì„± ë˜ì—ˆìŠµë‹ˆë‹¤.\n\në¡œê·¸ì¸ í›„ ì´ìš©í•´ ì£¼ì„¸ìš”.");
      }catch(err){
        console.error(err);
        const msg = (err && err.message) ? err.message : String(err);
        if(String(err && err.code).includes("permission_denied")){
          alertModal("ë°ì´í„°ë² ì´ìŠ¤ ê¶Œí•œ ì˜¤ë¥˜ì…ë‹ˆë‹¤.\n\n- Authentication: Anonymous í™œì„±í™” í™•ì¸\n- Database ê·œì¹™(.read/.write) í™•ì¸", "ê¶Œí•œ ì˜¤ë¥˜");
        }else if(msg.includes("databaseURL")){
          alertModal("firebaseConfig.databaseURLì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.", "ì„¤ì • ì˜¤ë¥˜");
        }else{
          alertModal("ë“±ë¡í•˜ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n" + msg, "ì˜¤ë¥˜");
        }
      }
    });
  };

  $("#login-btn").onclick = async ()=>{
    await withLoading(async ()=>{
      try{
        const uid = $("#login-uid").value.trim();
        const pin = $("#login-pin").value.trim();
        if(!uid) return alertModal("ê³ ìœ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        const user = await getUser(uid);
        if(!user){ return alertModal("í•´ë‹¹ ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤.\n\në‹¤ì‹œ ì‹œë„í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤."); }
        if(user.pin !== pin){ return alertModal("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n\në‹¤ì‹œ ì‹œë„í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤."); }
        currentUid = uid; currentPin = pin;

        const patch = {};
        if(typeof user.likeLimit!=="number") patch.likeLimit = 7;
        if(typeof user.likeSentCount!=="number"){ patch.likeSentCount = await countLikesSent(currentUid); }
        if(Object.keys(patch).length) await update(r(`users/${currentUid}`), patch);

        attachRealtimeListeners();
        await refreshLikeCounters();
        await checkUnseenLikes();
        await refreshMessageBadge_setup(); // âœ… ë¡œê·¸ì¸ ì‹œ ë¯¸ì½ìŒ ë±ƒì§€ ì„¸íŒ…
        go("menu");
      }catch(err){
        console.error(err);
        alertModal("ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n" + ((err && err.message) ? err.message : String(err)));
      }
    });
  };

  function doLogout(){
    detachRealtimeListeners();
    currentUid = null; currentPin = null;
    go("welcome");
    $("#msg-badge").classList.add("hidden");
  }
  ["#logout-btn","#logout-btn1","#logout-btn2","#logout-btn3","#logout-btn4","#logout-btn-msg","#logout-btn-chat"].forEach(sel=>{
    const el = $(sel); if(el) el.onclick = doLogout;
  });

  // ë©”ë‰´ ì´ë™
  ["#to-menu1","#to-menu2","#to-menu3","#to-menu4"].forEach(sel=>{
    const el = $(sel); if(el) el.onclick = ()=> go("menu");
  });
  $("#btn-profile").onclick = ()=>{ $("#me-uid-profile").textContent = currentUid; loadProfile(); go("profile"); };
  $("#btn-browse").onclick = async ()=>{ await loadBrowse(); await refreshLikeCounters(); go("browse"); };
  $("#btn-like").onclick   = async ()=>{ $("#from-like").value=`ë‚´ ë²ˆí˜¸: ${currentUid}`; $("#to-like").value=""; await refreshLikeCounters(); go("like"); };
  $("#btn-matches").onclick= ()=>{ loadMatches(); go("matches"); };

  // âœ… ë©”ì„¸ì§€í•¨ ì§„ì… ë²„íŠ¼
  $("#btn-messages").onclick = async ()=>{ await loadMessageList(); go("messages"); };
  // âœ… ëŒ€í™”ì°½ ë’¤ë¡œê°€ê¸°: ëŒ€í™”ëª©ë¡ìœ¼ë¡œ ë³µê·€
  $("#back-to-messages").onclick = async ()=>{ await loadMessageList(); go("messages"); };
  $("#to-menu-msg").onclick  = ()=> go("menu");

  // í”„ë¡œí•„ ì €ì¥/ì·¨ì†Œ
  async function loadProfile(){
    const u = await getUser(currentUid);
    $("#intro").value = (u && u.intro)||"";
    $("#ideal").value = (u && u.ideal)||"";
  }
  $("#profile-save").onclick = async ()=>{
    await withLoading(async ()=>{
      await update(r(`users/${currentUid}`), {
        intro: $("#intro").value.trim().slice(0,50),
        ideal: $("#ideal").value.trim().slice(0,50)
      });
      await alertModal("í”„ë¡œí•„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
      go("menu");
    });
  };
  $("#profile-cancel").onclick = ()=>go("menu");

  // ===== ë‹¤ë¥¸ì‚¬ëŒ êµ¬ê²½ (+ê²€ìƒ‰) =====
  async function loadBrowse(filterUid=null){
    const wrap = $("#browse-list");
    wrap.innerHTML = "";
    const snap = await get(r("users"));
    if(!snap.exists()){ wrap.innerHTML = `<div class="muted small">ì•„ì§ ê°€ì…ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>`; return; }
    const users = snap.val();
    let ids = Object.keys(users).filter(id=>id!==currentUid);
    if(filterUid){ ids = ids.filter(x=>x===filterUid); }
    ids.sort((a,b)=>Number(a)-Number(b));
    if(ids.length===0){ wrap.innerHTML = `<div class="muted small">í•´ë‹¹ ë²ˆí˜¸ì˜ í”„ë¡œí•„ì´ ì—†ìŠµë‹ˆë‹¤.</div>`; return; }

    ids.forEach(id=>{
      const u = users[id];
      const item = document.createElement("div");
      item.className="list-item";
      item.innerHTML = `
        <div class="li-content">
          <div><strong>${id}ë²ˆ</strong></div>
          <div class="small muted" style="margin-top:4px;">ìê¸°ì†Œê°œ: ${u.intro||"-"}</div>
          <div class="small muted" style="margin-top:2px;">ì´ìƒí˜•: ${u.ideal||"-"}</div>
        </div>
        <div class="li-actions">
          <button class="btn-like small" data-like="${id}">ğŸ‘LIKE</button>
        </div>
      `;
      wrap.appendChild(item);
    });

    wrap.querySelectorAll("[data-like]").forEach(btn=>{
      const toId = btn.getAttribute("data-like");
      btn.onclick = ()=> {
        if(likeRemain<=0){ alertModal("LIKEë¥¼ ëª¨ë‘ ì‚¬ìš©í•˜ì˜€ìŠµë‹ˆë‹¤."); return; }
        sendLike(toId);
      };
    });
  }
  $("#browse-search-btn").onclick = async ()=>{
    const v = $("#browse-search-input").value.trim();
    if(!v || !/^\d+$/.test(v)) return loadBrowse(null);
    await loadBrowse(v);
  };
  $("#browse-search-clear").onclick = ()=>{ $("#browse-search-input").value=""; loadBrowse(null); };

  // ===== LIKE ë³´ë‚´ê¸° =====
  $("#send-like-btn").onclick = async ()=>{
    if(likeRemain<=0){ return alertModal("LIKEë¥¼ ëª¨ë‘ ì‚¬ìš©í•˜ì˜€ìŠµë‹ˆë‹¤."); }
    const toId = $("#to-like").value.trim();
    if(!/^\d+$/.test(toId)) return alertModal("ìƒëŒ€ë°© ë²ˆí˜¸ë¥¼ ìˆ«ìë¡œ ì…ë ¥í•˜ì„¸ìš”.");
    await withLoading(async ()=>{ await sendLike(toId); });
  };

  async function sendLike(toId){
    if(!currentUid) return;
    if(likeRemain<=0) return alertModal("LIKEë¥¼ ëª¨ë‘ ì‚¬ìš©í•˜ì˜€ìŠµë‹ˆë‹¤.");
    if(toId===currentUid) return alertModal("ë³¸ì¸ì—ê²ŒëŠ” ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    const exists = await userExists(toId);
    if(!exists) return alertModal("í•´ë‹¹ ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤.\n\në‹¤ì‹œ ì‹œë„í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.");

    const already = await get(r(`likes/${currentUid}/${toId}`));
    if(already.exists()){
      return alertModal("ì´ë¯¸ ì´ ì‚¬ìš©ìì—ê²Œ LIKEë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤.");
    }

    const userRef = r(`users/${currentUid}`);
    const ok = await runTransaction(userRef, (u)=>{
      if(!u) return u;
      if(typeof u.likeLimit!=="number") u.likeLimit = 7;
      if(typeof u.likeSentCount!=="number") u.likeSentCount = 0;
      if(u.likeSentCount >= u.likeLimit){ return u; }
      u.likeSentCount += 1;
      return u;
    });
    const val = ok && ok.snapshot && ok.snapshot.val();
    if(!val) return alertModal("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
    if(val.likeSentCount > val.likeLimit){
      await update(userRef, { likeSentCount: val.likeLimit });
      return alertModal("LIKEë¥¼ ëª¨ë‘ ì‚¬ìš©í•˜ì˜€ìŠµë‹ˆë‹¤.");
    }

    await set(r(`likes/${currentUid}/${toId}`), true);
    await set(r(`likesReceived/${toId}/${currentUid}`), { ok:true, updatedAt: Date.now(), seen:false });

    const reciprocal = await get(r(`likes/${toId}/${currentUid}`));
    if (reciprocal.exists()){
  const now = Date.now();
  const payloadSender   = { status: "matched", updatedAt: now, notified: true  };  // ë³´ë‚¸ ì‚¬ëŒì€ ì¦‰ì‹œ ë´„
  const payloadReceiver = { status: "matched", updatedAt: now, notified: false };  // ë°›ì€ ì‚¬ëŒì€ ë‚˜ì¤‘ì— ë°˜ë“œì‹œ íŒì—…

  await update(r(`matches/${currentUid}/${toId}`), payloadSender);
  await update(r(`matches/${toId}/${currentUid}`), payloadReceiver);

  await alertModal(`${toId}ë²ˆ ì‚¬ìš©ìì™€ MATCHê°€ ë˜ì—ˆìŠµë‹ˆë‹¤!\nâ­ â­ â­ â­ â­\në§¤ì¹˜ í˜„í™©ì„ í™•ì¸í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.`);
} else {
  await alertModal("LIKEê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
}

    await refreshLikeCounters();
  }

  // ===== LIKE ìˆ˜ì‹  ë¯¸í™•ì¸ ì•Œë¦¼ ì²˜ë¦¬ =====
  async function checkUnseenLikes(){
    if(!currentUid) return;
    const snap = await get(r(`likesReceived/${currentUid}`));
    if(!snap.exists()) return;
    const recvs = snap.val();
    for(const from of Object.keys(recvs)){
      const v = recvs[from];
      if(v && v.ok && v.seen===false){
        await alertModal("ëˆ„êµ°ê°€ì—ê²Œ LIKEğŸ‘ë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤.", "â¤ï¸LIKE ì•Œë¦¼â¤ï¸");
        await update(r(`likesReceived/${currentUid}/${from}`), { seen:true });
      }
    }
  }

  // ===================== ğŸ’¬ ë©”ì„¸ì§€ ê¸°ëŠ¥ =====================
  async function loadMessageList(){
  const wrap = $("#message-list");
  wrap.innerHTML = "";

  const snap = await get(r(`matches/${currentUid}`));
  if(!snap.exists()){ $("#no-messages").classList.remove("hidden"); return; }
  const data = snap.val();
  const ids = Object.keys(data)
    .filter(k=>{
      const s = data[k]?.status;
      return s==="matched" || s==="meeting_requested" || s==="meeting_accepted";
    })
    .sort((a,b)=>Number(a)-Number(b));

  if(ids.length===0){ $("#no-messages").classList.remove("hidden"); return; }
  $("#no-messages").classList.add("hidden");

  // ìƒëŒ€ë³„ ë¯¸ì½ìŒ ìˆ˜ ì§‘ê³„
  const rows = await Promise.all(ids.map(async(other)=>{
    const pairKey = makeChatKey(currentUid, other);
    const msSnap = await get(r(`messages/${pairKey}`));
    let unread = 0;
    if(msSnap.exists()){
      const msgs = msSnap.val();
      for(const id in msgs){
        const m = msgs[id];
        if(m.to===currentUid && !m.read) unread++;
      }
    }
    // HTML ë¬¸ìì—´ ë°˜í™˜
    return `
      <div class="list-item" data-open-chat="${other}">
        <div class="li-content"><strong>${other}ë²ˆ</strong></div>
        ${
          unread>0
          ? `<span class="badge badge-red">${unread}</span>`
          : ``
        }
      </div>`;
  }));

  wrap.innerHTML = rows.join("");

  // í´ë¦­ í•¸ë“¤ëŸ¬
  wrap.querySelectorAll("[data-open-chat]").forEach(div=>{
    div.onclick = ()=> openChat(div.getAttribute("data-open-chat"));
  });
}

  async function openChat(otherUid){
    $("#chat-with").textContent = otherUid;
    const chatBox=$("#chat-box"); chatBox.innerHTML="";
    $("#chat-info").textContent="";
    go("chat");

    // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ í•´ì œ
    if(chatListener){ try{ chatListener(); }catch{} chatListener=null; }

    const pairKey = makeChatKey(currentUid, otherUid);
    const chatRef = r(`messages/${pairKey}`);

    // ì‹¤ì‹œê°„ ë©”ì‹œì§€ í‘œì‹œ
        chatListener = onValue(chatRef,(snap)=>{
  chatBox.innerHTML="";
  if(!snap.exists()) return;
  const msgs = Object.entries(snap.val())
    .map(([id,m])=>({id,...m}))
    .sort((a,b)=>a.time-b.time);

  msgs.forEach(m=>{
  const row = document.createElement("div");
  row.className = "msg-row " + (m.from===currentUid ? "me" : "other");

  // ë§í’ì„  ë˜í¼ (í­ ì œí•œ ë‹´ë‹¹)
  const wrap = document.createElement("div");
  wrap.className = "msg-wrap";

  // ë§í’ì„ 
  const bubble = document.createElement("div");
  bubble.className = "bubble " + (m.from===currentUid ? "me" : "other");
  bubble.textContent = m.text;

  // ì‹œê°„/ì½ìŒ
  const dt = new Date(m.time || 0);
  const hh = String(dt.getHours()).padStart(2,"0");
  const mm = String(dt.getMinutes()).padStart(2,"0");
  const timeStr = `${hh}:${mm}`;
  const readStr = (m.from===currentUid && m.read) ? "ì½ìŒ" : "";
  const meta = document.createElement("span");
  meta.className = "msg-meta";
  meta.textContent = readStr ? `${timeStr} Â· ${readStr}` : `${timeStr}`;

  // ì¡°ë¦½: [wrap(bubble)] [meta]  â‡’ ì¹´í†¡ì²˜ëŸ¼ ë§í’ì„  ì˜¤ë¥¸ìª½ì— ì‹œê°„
  wrap.appendChild(bubble);
  row.appendChild(wrap);
  row.appendChild(meta);

  chatBox.appendChild(row);
});

  chatBox.scrollTop = chatBox.scrollHeight;

  // ì±„íŒ…ì°½ ì—´ë¦° ìƒíƒœì—ì„œë„ ìƒˆë¡œ ì˜¨ ë©”ì‹œì§€ ì¦‰ì‹œ ì½ìŒ ì²˜ë¦¬
  markAsRead(pairKey, currentUid);
});

    // ì½ìŒ ì²˜ë¦¬
    await markAsRead(pairKey, currentUid);

    // ë³´ë‚´ê¸° ë²„íŠ¼ ì„¤ì • (ì¤‘ë³µ ë°©ì§€ ìœ„í•´ ì¬ì§€ì •)
    $("#chat-send").onclick = ()=> sendMessage(otherUid);
  }

  async function markAsRead(pairKey, myUid){
    const path = r(`messages/${pairKey}`);
    const snap = await get(path);
    if(!snap.exists()) return;
    const updates = {};
    Object.entries(snap.val()).forEach(([id, m])=>{
      if(m.to===myUid && !m.read){
        updates[`${id}/read`] = true;
      }
    });
    if(Object.keys(updates).length){
      await update(path, updates);
      await refreshMessageBadge_recount(); // ì½ìŒ ë°˜ì˜
    }
  }

  async function sendMessage(toUid){
    const inp=$("#chat-input");
    const text=inp.value.trim();
    if(!text) return;
    if(text.length>20) return alertModal("20ì ì´ë‚´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.");

    // ìƒëŒ€ì™€ ë§¤ì¹˜ ìƒíƒœì¸ì§€ í™•ì¸ (ë§¤ì¹˜/ìš”ì²­/ì„±ì‚¬ â€” ì„¸ ìƒíƒœ í—ˆìš©)
    const mSnap = await get(r(`matches/${currentUid}/${toUid}`));
    if(!mSnap.exists()){
      return alertModal("ë§¤ì¹˜ëœ ì‚¬ìš©ìì—ê²Œë§Œ ë©”ì„¸ì§€ë¥¼ ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
    }

// ë‚´ ì „ì†¡ íšŸìˆ˜(ìƒëŒ€ë³„) ì œí•œ: 7íšŒ
const pairKey = makeChatKey(currentUid, toUid);
const path = r(`messages/${pairKey}`);
const s = await get(path);
let myCount = 0;
if(s.exists()){
  const vals = s.val();
  for(const id in vals){ if(vals[id].from===currentUid) myCount++; }
}
if(myCount >= 7){
  const ok = await confirmModal(
    "ë” ë§ì€ ëŒ€í™”ë¥¼ ì›í•˜ì‹œë©´ ë§Œë‚¨ì„ ìš”ì²­í•˜ì„¸ìš”!",
    { okText:"ë§Œë‚¨ ìš”ì²­í•˜ê¸°", cancelText:"ë‹«ê¸°", title:"ë©”ì„¸ì§€ í•œë„ ì´ˆê³¼", okClass:"btn-success" } // âœ… ìƒ‰ìƒ í†µì¼
  );
  if(ok){
    // âœ… ì›ë³¸ê³¼ ë™ì¼í•œ ë¡œì§ìœ¼ë¡œ 'ë§Œë‚¨ ìš”ì²­'
    await set(r(`meetingRequests/${toUid}/${currentUid}`), {status:"pending", updatedAt: Date.now()});
    await update(r(`matches/${currentUid}/${toUid}`), {status:"meeting_requested", updatedAt: Date.now()});
    await alertModal("ë§Œë‚¨ ìš”ì²­ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
  }
  return;
}

    // ì €ì¥ (ë‹¨ì¼ ê²½ë¡œ; ì–‘ìª½ ê³µìš© pairKey)
    const id = Date.now()+"_"+Math.random().toString(36).slice(2,7);
    const msgObj = { from: currentUid, to: toUid, text, read:false, time: Date.now() };
    await update(path, { [id]: msgObj });

    inp.value = "";
    await refreshMessageBadge_recount(); // ë³´ë‚¸ ì§í›„ ë±ƒì§€ ê°±ì‹ (ìƒëŒ€ ì¸¡ì—ë§Œ ì¦ê°€ë˜ì§€ë§Œ ì•ˆì „í•˜ê²Œ ì¬ê³„ì‚°)
  }

  // ===== ë¯¸ì½ìŒ ë±ƒì§€ =====
  async function refreshMessageBadge_setup(){
    // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ í•´ì œ
    messagePairListeners.forEach(off=>{ try{off();}catch{} });
    messagePairListeners = [];

    // ë§¤ì¹˜ ëª©ë¡ì„ ë³´ê³ , ê° í˜ì–´ í‚¤ì— ëŒ€í•´ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ê±¸ì–´ ë¯¸ì½ìŒ ì´í•© ê°±ì‹ 
    const snap = await get(r(`matches/${currentUid}`));
    if(!snap.exists()){ setBadge(0); return; }
    const ids = Object.keys(snap.val());
    if(ids.length===0){ setBadge(0); return; }

    const pairs = ids.map(o=> makeChatKey(currentUid,o));
    pairs.forEach(pairKey=>{
      const off = onValue(r(`messages/${pairKey}`), ()=>{
        refreshMessageBadge_recount();
      });
      messagePairListeners.push(()=> off());
    });

    // ì´ˆê¸° 1íšŒ ê³„ì‚°
    await refreshMessageBadge_recount();
  }

  async function refreshMessageBadge_recount(){
    if(!currentUid) return setBadge(0);
    let unread = 0;

    const snap = await get(r(`matches/${currentUid}`));
    if(snap.exists()){
      const ids = Object.keys(snap.val());
      for(const other of ids){
        const pairKey = makeChatKey(currentUid, other);
        const ms = await get(r(`messages/${pairKey}`));
        if(ms.exists()){
          const vals = ms.val();
          for(const id in vals){
            const m = vals[id];
            if(m.to===currentUid && !m.read) unread++;
          }
        }
      }
    }
    setBadge(unread);
  }
  function setBadge(n){
  const badge = $("#msg-badge");
  if(!badge) return;

  // ê¸°ë³¸ í‘œì‹œ/í´ë˜ìŠ¤ ì •ë¦¬
  badge.classList.add("badge");       // ë³´ì¥
  badge.classList.add("badge-red");   // âœ… í•­ìƒ ë¹¨ê°„ìƒ‰
  if (n > 0){
    badge.textContent = String(n);
    badge.classList.remove("hidden");
  } else {
    badge.classList.add("hidden");
  }
}

  // ===== ë‚˜ì˜ MATCH í˜„í™© (+ ë³´ë¥˜ ì²˜ë¦¬) =====
  async function loadMatches(){
    const wrap = $("#matches-list");
    wrap.innerHTML = "";

    const snap = await get(r(`matches/${currentUid}`));
    if(snap.exists()){
      const list = snap.val();
      const ids = Object.keys(list).sort((a,b)=>Number(a)-Number(b));
      ids.forEach(other=>{
        const m = list[other];
        const row = document.createElement("div");
        row.className="list-item";
        let right = "";
        if(m.status==="matched"){
          right = `<button class="btn-success small" data-meet="${other}">ë§Œë‚¨<br>ìš”ì²­í•˜ê¸°</button>`;
        }else if(m.status==="meeting_requested"){
          right = `<span class="small badge">ìš”ì²­ ì§„í–‰ì¤‘</span>`;
        }else if(m.status==="meeting_accepted"){
          right = `
            <span class="small badge" style="background:#14532d;border-color:#1d7a49">ë§Œë‚¨<br>ì„±ì‚¬</span>
            <button class="btn small" data-staff="${other}">ì§ì›<br>í™•ì¸</button>
          `;
        }
        row.innerHTML = `
          <div class="li-content">
            <div><strong>${other}ë²ˆ</strong></div>
            <div class="small muted">ìƒíƒœ: ${statusKorean(m.status)}</div>
          </div>
          <div class="li-actions">${right}</div>
        `;
        wrap.appendChild(row);
      });

      wrap.querySelectorAll("[data-meet]").forEach(btn=>{
        btn.onclick = async ()=>{
          const target = btn.getAttribute("data-meet");
          await withLoading(async ()=>{
            await set(r(`meetingRequests/${target}/${currentUid}`), {status:"pending", updatedAt: Date.now()});
            await update(r(`matches/${currentUid}/${target}`), {status:"meeting_requested", updatedAt: Date.now()});
          });
          await alertModal("ë§Œë‚¨ ìš”ì²­ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
          loadMatches();
        };
      });

      wrap.querySelectorAll("[data-staff]").forEach(btn=>{
        btn.onclick = async ()=>{
          const other = btn.getAttribute("data-staff");
          const ok = await confirmModal("ì§ì›í™•ì¸ì´ ì™„ë£Œë˜ë©´ ë§¤ì¹˜í˜„í™©ì€ ì‚­ì œë©ë‹ˆë‹¤.\n\nê·¸ë˜ë„ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?",{okText:"í™•ì¸",cancelText:"ì·¨ì†Œ"});
          if(!ok) return;
          await withLoading(async ()=>{ await clearPairData(currentUid, other); });
          await alertModal("ë§¤ì¹˜ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
          loadMatches();
        };
      });
    }

    const reqSnap = await get(r(`meetingRequests/${currentUid}`));
    if(reqSnap.exists()){
      const reqs = reqSnap.val();
      const froms = Object.keys(reqs).sort((a,b)=>Number(a)-Number(b));
      froms.forEach(fromUid=>{
        const req = reqs[fromUid];
        if(req.status==="pending" || req.status==="held"){
          const row = document.createElement("div");
          row.className = "list-item";
          row.innerHTML = `
            <div class="li-content">
              <div><strong>${fromUid}ë²ˆ</strong></div>
              <div class="small muted">ìƒíƒœ: ${req.status==="held"?"ë³´ë¥˜ ì¤‘":"ë§Œë‚¨ ìš”ì²­ ë„ì°©"}</div>
            </div>
            <div class="li-actions">
              <button class="btn-danger small" data-decline="${fromUid}">ê±°ì ˆ</button>
              <button class="btn-primary small" data-accept="${fromUid}">ìˆ˜ë½</button>
            </div>
          `;
          wrap.appendChild(row);
        }
      });

      wrap.querySelectorAll("[data-decline]").forEach(btn=>{
        btn.onclick = async ()=>{
          const fromUid = btn.getAttribute("data-decline");
          await withLoading(async ()=>{ await clearPairData(currentUid, fromUid); });
          loadMatches();
        };
      });
      wrap.querySelectorAll("[data-accept]").forEach(btn=>{
        btn.onclick = async ()=>{
          const fromUid = btn.getAttribute("data-accept");
          await withLoading(async ()=>{
            await update(r(`matches/${currentUid}/${fromUid}`), {status:"meeting_accepted", updatedAt: Date.now()});
            await update(r(`matches/${fromUid}/${currentUid}`), {status:"meeting_accepted", updatedAt: Date.now()});
            await remove(r(`meetingRequests/${currentUid}/${fromUid}`));
          });
          await alertModal("ë§Œë‚¨ì´ ì„±ì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ‘‰ ğŸ’› ğŸ‘ˆ\nì§€ê¸ˆë°”ë¡œ ë§Œë‚¨ì„ ìœ„í•´ ì§ì›ì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”!");
          loadMatches();
        };
      });
    }

    if(!snap.exists() && !reqSnap.exists()){
      wrap.innerHTML = `<div class="muted small">ì•„ì§ ë§¤ì¹˜/ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
    }
  }

  function statusKorean(s){
    return s==="matched" ? "ë§¤ì¹˜ë¨"
      : s==="meeting_requested" ? "ë§Œë‚¨ ìš”ì²­ ì¤‘"
      : s==="meeting_accepted" ? "ë§Œë‚¨ ì„±ì‚¬"
      : s;
  }

  async function clearPairData(a,b){
    const ops = [
      remove(r(`matches/${a}/${b}`)),
      remove(r(`matches/${b}/${a}`)),
      remove(r(`likes/${a}/${b}`)),
      remove(r(`likes/${b}/${a}`)),
      remove(r(`likesReceived/${a}/${b}`)),
      remove(r(`likesReceived/${b}/${a}`)),
      remove(r(`meetingRequests/${a}/${b}`)),
      remove(r(`meetingRequests/${b}/${a}`)),
      // âœ… ë©”ì‹œì§€ê¹Œì§€ ì œê±°
      remove(r(`messages/${makeChatKey(a,b)}`))
    ];
    await Promise.all(ops);
  }

  // ===================== ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ =====================
  let detachFns = [];
  function attachRealtimeListeners(){
    detachRealtimeListeners();
    if(!currentUid) return;

    // ë‚´ ë§¤ì¹˜ ìƒíƒœ ë³€í™”
    const off1 = onValue(r(`matches/${currentUid}`), async (snap)=>{
  if(!snap.exists()) return;
  const data = snap.val();

  for (const [other, m] of Object.entries(data)) {
    if (!m) continue;

    // âœ… 1) ì•„ì§ ë‚´ê°€ ëª» ë³¸ ë§¤ì¹˜ë¼ë©´, ì‹œê°„ ê²½ê³¼ì™€ ë¬´ê´€í•˜ê²Œ ë°˜ë“œì‹œ í•œ ë²ˆ ì•Œë¦¼
    if (m.status === "matched" && m.notified !== true) {
      await alertModal(`${other}ë²ˆ ì‚¬ìš©ìì™€ MATCHê°€ ë˜ì—ˆìŠµë‹ˆë‹¤!\nâ­ â­ â­ â­ â­\në§¤ì¹˜ í˜„í™©ì„ í™•ì¸í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.`);
      await update(r(`matches/${currentUid}/${other}`), { notified: true, updatedAt: Date.now() });
      continue; // ì•„ë˜ ì‹œê°„ê¸°ë°˜ ì•Œë¦¼ì€ ìŠ¤í‚µ
    }

    // (ì„ íƒ) ê¸°ì¡´ 4ì´ˆ ë‚´ ì¦‰ì‹œ ì•Œë¦¼ ë¡œì§ ìœ ì§€
    if (m.status === "matched" && (Date.now() - (m.updatedAt||0)) < 4000) {
      await alertModal(`${other}ë²ˆ ì‚¬ìš©ìì™€ MATCHê°€ ë˜ì—ˆìŠµë‹ˆë‹¤!\nâ­ â­ â­ â­ â­\në§¤ì¹˜ í˜„í™©ì„ í™•ì¸í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.`);
      if (m.notified !== true) {
        await update(r(`matches/${currentUid}/${other}`), { notified: true });
      }
    }

    // ê¸°ì¡´ meeting_accepted ì•Œë¦¼ì€ ìœ ì§€
    if (m && m.status === "meeting_accepted" && (Date.now() - (m.updatedAt||0)) < 4000) {
      await alertModal("ë§Œë‚¨ì´ ì„±ì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ‘‰ ğŸ’› ğŸ‘ˆ\nì§€ê¸ˆë°”ë¡œ ë§Œë‚¨ì„ ìœ„í•´ ì§ì›ì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”!");
    }
  }

  if(!pages.matches.classList.contains("hidden")) loadMatches();
});
    detachFns.push(()=>off1());

    // ë‚´ê°€ ë°›ì€ ë§Œë‚¨ ìš”ì²­
    const off2 = onValue(r(`meetingRequests/${currentUid}`), async snap=>{
      if(!snap.exists()) return;
      const reqs = snap.val();
      for(const fromUid of Object.keys(reqs)){
        const req = reqs[fromUid];
        if(req.status==="pending"){
          const accepted = await choiceModal(`${fromUid}ë²ˆê³¼ì˜ ë§Œë‚¨ ìš”ì²­ì„ ìˆ˜ë½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
          if(accepted===true){
            await update(r(`matches/${currentUid}/${fromUid}`), {status:"meeting_accepted", updatedAt: Date.now()});
            await update(r(`matches/${fromUid}/${currentUid}`), {status:"meeting_accepted", updatedAt: Date.now()});
            await remove(r(`meetingRequests/${currentUid}/${fromUid}`));
            await alertModal("ë§Œë‚¨ì´ ì„±ì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ‘‰ğŸ’›ğŸ‘ˆ\nì§€ê¸ˆë°”ë¡œ ë§Œë‚¨ì„ ìœ„í•´ ì§ì›ì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”!");
          }else if(accepted===false){
            await clearPairData(currentUid, fromUid);
          }else{
            await update(r(`meetingRequests/${currentUid}/${fromUid}`), {status:"held", updatedAt: Date.now()});
          }
        }
      }
      if(!pages.matches.classList.contains("hidden")) loadMatches();
    });
    detachFns.push(()=>off2());

    // ë°›ì€ LIKE ì‹¤ì‹œê°„ ì•Œë¦¼
    const off3 = onValue(r(`likesReceived/${currentUid}`), async snap=>{
      if(!snap.exists()) return;
      const recvs = snap.val();
      for(const from of Object.keys(recvs)){
        const v = recvs[from];
        if(v && v.ok && v.seen===false){
          await alertModal("ëˆ„êµ°ê°€ì—ê²Œ LIKEğŸ‘ë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤.", "â¤ï¸LIKE ì•Œë¦¼â¤ï¸");
          await update(r(`likesReceived/${currentUid}/${from}`), { seen:true });
        }
      }
    });
    detachFns.push(()=>off3());

    // ë©”ì„¸ì§€ ë±ƒì§€ ë¦¬ìŠ¤ë„ˆ ì…‹ì—…
    refreshMessageBadge_setup();

    updateConnectionLabels();
  }
  function detachRealtimeListeners(){
    detachFns.forEach(fn=>{ try{fn();}catch{} });
    detachFns = [];

    // ë©”ì„¸ì§€ ë±ƒì§€/ì±„íŒ… ë¦¬ìŠ¤ë„ˆ í•´ì œ
    messagePairListeners.forEach(off=>{ try{off();}catch{} });
    messagePairListeners = [];
    if(chatListener){ try{chatListener();}catch{} chatListener=null; }

    updateConnectionLabels();
  }

  // ===================== ê´€ë¦¬ì =====================
  $("#admin-entry-btn").onclick = ()=> go("adminGate");
  $("#admin-cancel").onclick = ()=> go("welcome");
  $("#admin-login").onclick = ()=>{
    const id = $("#admin-id").value.trim();
    const pw = $("#admin-pw").value.trim();
    if(id===ADMIN_ID && pw===ADMIN_PASSWORD){
      adminLoggedIn = true;
      $("#current-event").textContent = EVENT_ID;
      go("admin");
      setAdminTab("search");
    }else{
      alertModal("ê´€ë¦¬ì ì¸ì¦ ì‹¤íŒ¨");
    }
  };
  $("#admin-logout").onclick = ()=>{ adminLoggedIn = false; go("welcome"); };

  $("#apply-event-id").onclick = ()=>{
    const v = $("#event-id-input").value.trim();
    if(!v) return alertModal("ì´ë²¤íŠ¸ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
    EVENT_ID = v;
    localStorage.setItem("hm_event_id", EVENT_ID);
    $("#current-event").textContent = EVENT_ID;
    alertModal("ì´ë²¤íŠ¸ IDê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.");
    if(adminLoggedIn) setAdminTab(currentAdminTab);
  };

  let currentAdminTab = "search";
  function setAdminTab(tab){
    currentAdminTab = tab;
    $("#admin-panel-search").classList.toggle("hidden", tab!=="search");
    $("#admin-panel-matches").classList.toggle("hidden", tab!=="matches");
    $("#admin-panel-draw").classList.toggle("hidden", tab!=="draw");
    if(tab==="matches"){ renderAdminMatches(); }
    if(tab==="draw"){ renderDrawState(); }
  }
  $("#admin-tab-search").onclick = ()=> setAdminTab("search");
  $("#admin-tab-matches").onclick = ()=> setAdminTab("matches");
  $("#admin-tab-draw").onclick = ()=> setAdminTab("draw");

  $("#admin-search-btn").onclick = async ()=>{
    const uid = $("#admin-search-uid").value.trim();
    if(!uid || !/^\d+$/.test(uid)) return alertModal("ê³ ìœ ë²ˆí˜¸ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”.");
    const u = await getUser(uid);
    if(!u) {
      $("#admin-user-summary").textContent = "ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì‚¬ìš©ìì…ë‹ˆë‹¤.";
      $("#admin-sent-list").innerHTML=""; $("#admin-recv-list").innerHTML="";
      return;
    }

    $("#admin-user-summary").textContent =
      `${uid}ë²ˆ ì‚¬ìš©ì Â· LIKE ì œí•œ: ${(typeof u.likeLimit==="number")?u.likeLimit:7} Â· ë³´ë‚¸íšŸìˆ˜: ${(typeof u.likeSentCount==="number")?u.likeSentCount:await countLikesSent(uid)}`;

    $("#admin-like-limit").value = (typeof u.likeLimit==="number")?u.likeLimit:7;

    const sent = await get(r(`likes/${uid}`));
    const sentBox = $("#admin-sent-list"); sentBox.innerHTML="";
    if(sent.exists()){
      Object.keys(sent.val()).sort((a,b)=>Number(a)-Number(b)).forEach(to=>{
        const item = document.createElement("div");
        item.className="list-item";
        item.innerHTML = `<div class="li-content"><strong>${uid}ë²ˆ â†’ ${to}ë²ˆ</strong></div>`;
        sentBox.appendChild(item);
      });
    }else{
      sentBox.innerHTML = `<div class="muted small">ë³´ë‚¸ LIKE ì—†ìŒ</div>`;
    }

    const recv = await get(r(`likesReceived/${uid}`));
    const recvBox = $("#admin-recv-list"); recvBox.innerHTML="";
    if(recv.exists()){
      Object.keys(recv.val()).sort((a,b)=>Number(a)-Number(b)).forEach(from=>{
        const item = document.createElement("div");
        item.className="list-item";
        item.innerHTML = `<div class="li-content"><strong>${from}ë²ˆ â†’ ${uid}ë²ˆ</strong></div>`;
        recvBox.appendChild(item);
      });
    }else{
      recvBox.innerHTML = `<div class="muted small">ë°›ì€ LIKE ì—†ìŒ</div>`;
    }

    $("#admin-wipe-user").dataset.uid = uid;
  };

  $("#admin-like-limit-dec").onclick = ()=>{
    const inp = $("#admin-like-limit"); let v = parseInt(inp.value||"7",10); v = isNaN(v)?7:Math.max(0, v-1); inp.value = v;
  };
  $("#admin-like-limit-inc").onclick = ()=>{
    const inp = $("#admin-like-limit"); let v = parseInt(inp.value||"7",10); v = isNaN(v)?7:v+1; inp.value = v;
  };
  $("#admin-like-limit-save").onclick = async ()=>{
    const uid = $("#admin-search-uid").value.trim();
    const v = parseInt($("#admin-like-limit").value||"7",10);
    if(!uid || !/^\d+$/.test(uid)) return alertModal("ë¨¼ì € ì‚¬ìš©ì ë²ˆí˜¸ë¥¼ ì¡°íšŒí•˜ì„¸ìš”.");
    if(isNaN(v) || v<0) return alertModal("LIKE ì œí•œì€ 0 ì´ìƒì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.");
    await update(r(`users/${uid}`), { likeLimit: v });
    alertModal("LIKE ì œí•œì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
  };

  // ê²€ìƒ‰ íƒ­ì—ì„œ â€œì´ ì‚¬ìš©ì ë°ì´í„° ì „ë¶€ ì‚­ì œâ€
  $("#admin-wipe-user").onclick = async ()=>{
    const uid = $("#admin-wipe-user").dataset.uid || $("#admin-search-uid").value.trim();
    if(!uid) return alertModal("ë¨¼ì € ì‚¬ìš©ì ë²ˆí˜¸ë¥¼ ì¡°íšŒí•˜ì„¸ìš”.");
    const ok = await confirmModal(`${uid}ë²ˆ ì‚¬ìš©ìì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.\n\nê³„ì†í• ê¹Œìš”?`,{okText:"ì‚­ì œ"});
    if(!ok) return;

    await withLoading(async ()=>{
      await deleteUserAllData(uid);
    });

    await alertModal("í•´ë‹¹ ì‚¬ìš©ìì˜ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
    $("#admin-sent-list").innerHTML=""; $("#admin-recv-list").innerHTML="";
    $("#admin-user-summary").textContent = "ì‚­ì œ ì™„ë£Œ";
  };

  async function deleteUserAllData(uid){
    const ops = [
      remove(r(`users/${uid}`)),
      remove(r(`likes/${uid}`)),
      remove(r(`likesReceived/${uid}`)),
      remove(r(`matches/${uid}`)),
      remove(r(`meetingRequests/${uid}`))
    ];
    // ë°˜ëŒ€í¸ ì •ë¦¬
    const likesAll = await get(r(`likes`));
    if(likesAll.exists()){
      const all = likesAll.val();
      for(const from of Object.keys(all)){
        if(all[from] && all[from][uid]) ops.push(remove(r(`likes/${from}/${uid}`)));
      }
    }
    const recvAll = await get(r(`likesReceived`));
    if(recvAll.exists()){
      const all = recvAll.val();
      for(const to of Object.keys(all)){
        if(all[to] && all[to][uid]) ops.push(remove(r(`likesReceived/${to}/${uid}`)));
      }
    }
    const mAll = await get(r(`matches/${uid}`));
    if(mAll.exists()){
      const others = Object.keys(mAll.val());
      others.forEach(other=>{
        ops.push(remove(r(`matches/${uid}/${other}`)));
        ops.push(remove(r(`matches/${other}/${uid}`)));
      });
    }
    const reqAll = await get(r(`meetingRequests`));
    if(reqAll.exists()){
      const all = reqAll.val();
      for(const target of Object.keys(all)){
        if(all[target] && all[target][uid]){
          ops.push(remove(r(`meetingRequests/${target}/${uid}`)));
        }
      }
    }
    // âœ… ë©”ì‹œì§€: uidê°€ í¬í•¨ëœ ëª¨ë“  í˜ì–´í‚¤ ì‚­ì œ
    const msgAll = await get(r(`messages`));
    if(msgAll.exists()){
      const all = msgAll.val();
      for(const pairKey of Object.keys(all)){
        // pairKey: "small-big" í˜•ì‹
        const [a,b] = pairKey.split("-");
        if(a===uid || b===uid){
          ops.push(remove(r(`messages/${pairKey}`)));
        }
      }
    }
    await Promise.all(ops);
  }

  // --- ê´€ë¦¬ì: ë§¤ì¹˜/ë§Œë‚¨ ëª©ë¡ ë¶„ë¦¬ ---
  async function renderAdminMatches(){
    const boxMatch = $("#admin-matches"); boxMatch.innerHTML = "";
    const boxMeet  = $("#admin-meetings"); boxMeet.innerHTML = "";
    let pairsMatch = new Set();
    let pairsMeet  = new Set();
    let countMatch = 0;
    let countMeet  = 0;

    const all = await get(r("matches"));
    if(!all.exists()){
      boxMatch.innerHTML = `<div class="muted small">í˜„ì¬ ë§¤ì¹˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
      boxMeet.innerHTML = `<div class="muted small">í˜„ì¬ ë§Œë‚¨ ì„±ì‚¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
      $("#admin-match-count").textContent = "0";
      $("#admin-meet-count").textContent  = "0";
      return;
    }
    const data = all.val();

    for(const a of Object.keys(data)){
      const others = data[a];
      for(const b of Object.keys(others)){
        const st = (others[b] && others[b].status) || "";
        const key = [Math.min(+a,+b), Math.max(+a,+b)].join("-");
        if(st==="matched"){
          if(pairsMatch.has(key) || pairsMeet.has(key)) continue;
          pairsMatch.add(key);
          countMatch++;
          const item = document.createElement("div");
          item.className="list-item";
          item.innerHTML = `<div class="li-content"><strong>${a}ë²ˆ â†” ${b}ë²ˆ</strong> <span class="small badge">ë§¤ì¹˜ë¨</span></div>`;
          boxMatch.appendChild(item);
        }else if(st==="meeting_accepted"){
          if(pairsMeet.has(key)) continue;
          pairsMeet.add(key);
          countMeet++;
          const item = document.createElement("div");
          item.className="list-item";
          item.innerHTML = `<div class="li-content"><strong>${a}ë²ˆ â†” ${b}ë²ˆ</strong> <span class="small badge" style="background:#14532d;border-color:#1d7a49">ë§Œë‚¨ ì„±ì‚¬</span></div>`;
          boxMeet.appendChild(item);
        }
      }
    }
    if(countMatch===0) boxMatch.innerHTML = `<div class="muted small">í˜„ì¬ ë§¤ì¹˜ëœ ì»¤í”Œì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
    if(countMeet===0) boxMeet.innerHTML  = `<div class="muted small">í˜„ì¬ ë§Œë‚¨ ì„±ì‚¬ëœ ì»¤í”Œì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
    $("#admin-match-count").textContent = String(countMatch);
    $("#admin-meet-count").textContent  = String(countMeet);
  }

  // --- ê´€ë¦¬ì: ëœë¤ ë²ˆí˜¸ ë½‘ê¸° ---
  async function getAllRegisteredIds(){
    const snap = await get(r("users"));
    if(!snap.exists()) return [];
    return Object.keys(snap.val()).sort((a,b)=>Number(a)-Number(b));
  }
  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
    return arr;
  }
  async function drawOnce(poolKey){
    const allIds = await getAllRegisteredIds();
    if(allIds.length===0) return alertModal("ë“±ë¡ëœ ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤.");
    const drawnSnap = await get(r(`adminDraw/${poolKey}`));
    const drawnSet = drawnSnap.exists()? new Set(drawnSnap.val()) : new Set();
    const remain = allIds.filter(id=>!drawnSet.has(id));
    if(remain.length===0) return alertModal("ë” ì´ìƒ ì¶”ì²¨í•  ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤.\n\nì´ˆê¸°í™” í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.");
    const pick = shuffle(remain)[0];
    drawnSet.add(pick);
    await set(r(`adminDraw/${poolKey}`), Array.from(drawnSet));
    await alertModal(`${poolKey==="host"?"ì§„í–‰ììš©":"ì°¸ê°€ììš©"} ì¶”ì²¨ ë²ˆí˜¸: ${pick}ë²ˆ`);
    renderDrawState();
  }
  async function renderDrawState(){
    const host = await get(r(`adminDraw/host`));
    const guest = await get(r(`adminDraw/guest`));
    $("#draw-host-drawn").textContent = host.exists()? host.val().join(", ") : "(ì—†ìŒ)";
    $("#draw-guest-drawn").textContent = guest.exists()? guest.val().join(", ") : "(ì—†ìŒ)";
  }
  $("#draw-host").onclick  = ()=> drawOnce("host");
  $("#draw-guest").onclick = ()=> drawOnce("guest");
  $("#draw-reset").onclick = async ()=>{
    await remove(r(`adminDraw`));
    await alertModal("ì „ì²´ ì¶”ì²¨ ê¸°ë¡ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
    renderDrawState();
  };

  $("#admin-del-user").onclick = async ()=>{
    const uid = $("#admin-del-uid").value.trim();
    if(!uid) return alertModal("ì‚­ì œí•  ê³ ìœ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
    const ok = await confirmModal(`${uid}ë²ˆ ì‚¬ìš©ìì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.\n\nê³„ì†í• ê¹Œìš”?`,{okText:"ì‚­ì œ"});
    if(!ok) return;

    await withLoading(async ()=>{
      await deleteUserAllData(uid);
    });

    await alertModal("í•´ë‹¹ ì‚¬ìš©ìì˜ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
    renderAdminMatches();
  };

  $("#admin-reset").onclick = async ()=>{
    const ok = await confirmModal("ì´ ì´ë²¤íŠ¸ì˜ ëª¨ë“  ê³„ì •ê³¼ ë°ì´í„°ë¥¼\nì™„ì „íˆ ì‚­ì œí•©ë‹ˆë‹¤.\n\në˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", { okText:"ì´ˆê¸°í™”", cancelText:"ì·¨ì†Œ", title:"ì „ì²´ ì´ˆê¸°í™”" });
    if(!ok) return;
    await withLoading(async ()=>{
      await remove(r(`users`));
      await remove(r(`likes`));
      await remove(r(`likesReceived`));
      await remove(r(`matches`));
      await remove(r(`meetingRequests`));
      await remove(r(`adminDraw`));
      await remove(r(`messages`)); // âœ… ëª¨ë“  ë©”ì‹œì§€ ì´ˆê¸°í™”
    });
    await alertModal("ì „ì²´ ë°ì´í„° ì´ˆê¸°í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    renderAdminMatches();
  };

  // ===================== í˜ì´ì§€ ì „í™˜ =====================
  function go(id){
    Object.values(pages).forEach(hide);
    show(pages[id]);
    updateConnectionLabels();
  }

  // ======== ì‹œì‘ í˜ì´ì§€ ========
  go("welcome");
</script>
</body>

</html>






